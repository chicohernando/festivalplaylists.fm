<!DOCTYPE html>
<html>
  <head>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link href="/css/style.css" rel="stylesheet">
    <title>{{ playlist_title }} Playlist | flipthewaffle.com | easily digestable concert playlists</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="{{ playlist_title }} playlist has {{ song_count }} songs to get you ready for {{ playlist_title }}. Easily add the {{ playlist_title }} playlist to your Spotify." />
    <meta name="keywords" content="{{ playlist_title }}, {{ playlist_title }} playlist, {{ playlist_title }} spotify, playlist, spotify, spotify playlist" />
  </head>
  <body class="playlist-page">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-63501311-1', 'auto');
      ga('send', 'pageview');

    </script>
    <div class="intro festival-container">
      <div class="container">
        <img src="/images/logo.png">
        <h1>{{ playlist_title }}</h1>
        {{ include(template_from_string(content)) }}
        <p>
           Easily add the {{ playlist_title }} playlist to your Spotify account using the on screen button. You will be prompted to login to your Spotify account before being allowed to add the playlist. Once added, you will be notified if the playlist ever changes and your playlist will be updated automatically.
        </p>
      </div>
    </div>
    <div class="playlist-container">
      <div class="pseudo-menu">
        <img src="/images/logo.png">
        <button class="btn" id="btn-follow">Add {{ playlist_title }} to Spotify</button>
      </div>
      <button class="btn centered static-button" id="btn-follow">Add {{ playlist_title }} to Spotify</button>
      <input type="hidden" id="playlist-uri" value="{{ playlist_uri }}" />
      <div class="container playlist" id="results">
        {% for row in tracks|batch(2) %}
          <div class="row">
            {% for artist,artist_tracks in row %}
              <div class="grid-6">
                <div class="row">
                  <div class="grid-4 artist-name">{{ artist }}</div>
                  <ol class="grid-8 zebra-list">
                    {% for track in artist_tracks %}
                      <li>{{ track.title }} <span>{{ track.duration }}</span></li>
                    {% endfor %}
                  </ol>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <div class="row">
          <div class="grid-12">
            <ul class="horizontal centered">
              <li>
                <a href="{{ path('home') }}">Flip the Waffle</a>
              </li>
              {% for playlist in playlists | slice(0,3) %}
                <li>
                  <a href="{{ path('playlist', {slug: playlist.slug}) }}">{{ playlist.name|e }}</a>
                </li>
              {% endfor %}
            </ul>
        </div>
      </div>
      <span class="centered">Created by <a href=
      "http://easander.com/">chicohernando</a>. Designed by
      <a href="http://www.github.com/niederer">niederer</a>.</span>
    </footer>
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="/js/index.js"></script>
    <script type="text/javascript">
      (function() {

          function login(callback) {
              var CLIENT_ID = 'bde96cbd16ec44548ab77ce86e187654';
              var REDIRECT_URI = 'http://flipthewaffle.com/follow-callback.html';
              function getLoginURL(scopes) {
                  return 'https://accounts.spotify.com/authorize?client_id=' + CLIENT_ID +
                    '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) +
                    '&scope=' + encodeURIComponent(scopes.join(' ')) +
                    '&response_type=token';
              }

              var url = getLoginURL([
                  'playlist-modify-public'
              ]);

              var width = 450,
                  height = 730,
                  left = (screen.width / 2) - (width / 2),
                  top = (screen.height / 2) - (height / 2);

              window.addEventListener("message", function(event) {
                  var hash = JSON.parse(event.data);
                  if (hash.type == 'access_token') {
                      callback(hash.access_token);
                  }
              }, false);

              var w = window.open(url,
                                  'Spotify',
                                  'menubar=no,location=no,resizable=no,scrollbars=no,status=no, width=' + width + ', height=' + height + ', top=' + top + ', left=' + left
                                 );

          }

          function followPlaylist(accessToken, playlistUri) {
              var parts = playlistUri.split(':');
              $.ajax({
                  url: 'https://api.spotify.com/v1/users/' + parts[2] + '/playlists/' + parts[4] + '/followers',
                  headers: {
                     'Authorization': 'Bearer ' + accessToken
                  },
                  method: 'PUT',
                  success: function() {
                      $('button').text('Following');
                      // followButton.textContent = 'Following';
                  },
                  dataType: 'html',
                  error: function(e) {
                      console.error(e);
                  }
              });
          }

          var followButton = document.getElementById('btn-follow'),
              playlistUriInput = document.getElementById('playlist-uri');

          $('body').on('click', 'button', function() {
              login(function(accessToken) {
                  followPlaylist(accessToken, playlistUriInput.value);
              });
          });

      })();
    </script>
  </body>
</html>